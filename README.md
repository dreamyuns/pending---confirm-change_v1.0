# 예약확정처리 시스템 v2.0

웹 인터페이스 연동 버전 - 프론트엔드에서 설정하고 실행하는 예약확정처리 자동화 시스템

## 🚀 주요 특징

- **웹 인터페이스**: 브라우저에서 설정하고 실행
- **실시간 모니터링**: 실행 상태를 실시간으로 확인
- **설정 관리**: 웹에서 설정 변경 및 저장
- **자동 저장**: 입력한 값이 localStorage에 자동 저장되어 새로고침 후에도 유지
- **실행 이력**: 모든 실행 기록을 웹에서 확인
- **독립 실행**: 포트 8001에서 독립적으로 실행
- **URL 자동 동기화**: 로그인 URL 변경 시 자동으로 base_url 동기화
- **프로젝트 중단**: 실행 중인 프로젝트를 안전하게 중단 가능

## 📁 폴더 구조

```
admin_예약확정처리_v1.0/
├── main.py                    # FastAPI 서버
├── frontend/
│   └── index.html             # 웹 UI
├── services/
│   ├── project_executor.py    # 프로젝트 실행기
│   └── excel_manager.py       # Excel 데이터 관리
├── data/
│   └── master_data.xlsx       # 마스터 데이터 (채널, 상태, 유형 등)
├── admin_confirm_rpa_v2.0.py  # RPA 스크립트 (웹 연동 버전)
├── admin_confirm_config.json  # 기본 설정
├── requirements.txt           # 의존성
├── uploads/                   # 엑셀 파일 업로드 폴더
├── logs/                      # 로그 파일
├── results/                   # 결과 파일
└── temp_configs/             # 임시 설정 파일 (실행 시 생성)
```

## 🛠️ 설치 및 실행

### 1. 저장소 클론 (GitHub에서 가져온 경우)

```bash
git clone https://github.com/your-username/admin-reservation-confirm.git
cd admin-reservation-confirm
```

### 2. 설정 파일 생성

```bash
# 예제 설정 파일을 복사하여 실제 설정 파일 생성
copy admin_confirm_config.example.json admin_confirm_config.json
```

그 다음 `admin_confirm_config.json` 파일을 열어 실제 로그인 정보와 설정을 입력하세요.

### 3. 의존성 설치

```bash
pip install -r requirements.txt
```

### 4. 서버 실행

```bash
python main.py
```

### 5. 웹 접속

브라우저에서 `http://localhost:8001` 접속

## 🔧 설정

웹 인터페이스에서 다음 설정을 변경할 수 있습니다:

### ⚙️ 기본설정

- **로그인 정보**
  - URL: 로그인 페이지 URL (예: `https://adm.allmytour.com`)
  - 아이디: 관리자 계정 아이디
  - 비밀번호: 관리자 계정 비밀번호
  - ⚠️ URL 변경 시 자동으로 `base_url`이 동기화됩니다 (포트 제거)

- **페이지 안정화 시간 설정**
  - 페이지 로딩 대기 시간
  - 상세페이지 대기 시간
  - 화면 새로고침 대기 시간
  - LMS 팝업 대기 시간

### 📅 검색설정

- **날짜 설정**
  - 시작 날짜
  - 종료 날짜
  - 날짜 유형 (구매일/이용일)

- **채널 검색**
  - 채널 선택 (올마이투어 등)

- **필터 설정**
  - 판매 유형 (B2C/B2B)
  - 예약일 유형 (지정/미지정)
  - 변경 전 상태 (검색 조건용 예약 상태, 기본값: pending(대기))
  - 페이지당 목록 개수 (10~100)

- **변경할 상태 설정**
  - 변경할 상태 (기본값: confirm(확정))

### 🧪 테스트모드설정

- 테스트 모드 활성화/비활성화
- 테스트 시작/종료 행

## 🚀 사용법

1. **엑셀 파일 업로드**: 기본설정 탭에서 처리할 엑셀 파일을 업로드합니다.
   - 파일 형식: 주문번호와 확정번호가 포함된 Excel 파일
   - 시트명: `list`
   - 업로드된 파일은 자동으로 설정에 저장됩니다

2. **설정 변경**: 각 탭에서 필요한 설정을 변경합니다.
   - 변경 후 "💾 저장" 버튼이 활성화됩니다
   - 저장 버튼 클릭 시 해당 탭의 설정만 서버에 저장됩니다
   - 입력한 값은 자동으로 localStorage에 저장되어 새로고침 후에도 유지됩니다

3. **프로젝트 실행**: 프로젝트실행 탭에서 "🚀 시작" 버튼을 클릭하여 프로젝트 실행

4. **상태 모니터링**: 실행 상태를 실시간으로 확인
   - 상태: 대기 중 / 실행 중 / 완료 / 실패 / 중단됨
   - 실행 시간 표시

5. **중단**: 필요시 "⏹️ 중단" 버튼으로 프로젝트 중단
   - 중단 후 즉시 상태가 업데이트됩니다
   - 중단 후 새 프로젝트를 바로 시작할 수 있습니다

6. **이력 확인**: 실행 이력 탭에서 과거 실행 기록 확인

## 📊 주요 기능

### 🔄 URL 자동 동기화

- 로그인 URL을 변경하면 자동으로 `base_url`이 동기화됩니다
- 개발서버 URL(`dev.allmytour.com`)이 있으면 운영서버 URL로 자동 변경됩니다
- 포트 번호는 자동으로 제거됩니다

예시:
- 로그인 URL: `https://adm.allmytour.com`
- 자동 설정된 base_url: `https://adm.allmytour.com`

### 💾 localStorage 자동 저장

- 입력한 모든 값이 브라우저에 자동 저장됩니다
- 새로고침 후에도 마지막 입력값이 유지됩니다
- 비밀번호는 보안상 저장되지 않습니다

저장되는 필드:
- 기본설정: 로그인 URL, 아이디, 페이지 안정화 시간
- 검색설정: 날짜, 채널, 필터, 상태 설정
- 테스트모드: 테스트 모드 설정

### 📑 탭별 저장 기능

- 각 탭별로 독립적인 저장 기능 제공
- 변경사항이 있을 때만 저장 버튼이 활성화됩니다
- 저장 시 해당 탭의 설정만 서버에 저장됩니다

### 🔍 검색 및 상태 변경

- **검색 필터**: 변경 전 상태를 기준으로 주문을 검색
- **상태 변경**: 검색된 주문의 상태를 목표 상태로 변경
- **Excel 처리**: Excel 파일의 주문번호와 확정번호를 읽어 처리

## 🔄 v1.7과의 차이점

- **웹 인터페이스**: 브라우저에서 설정하고 실행
- **실시간 모니터링**: 실행 상태를 실시간으로 확인
- **설정 관리**: 웹에서 설정 변경 및 저장
- **자동 저장**: localStorage를 통한 자동 저장 기능
- **URL 자동 동기화**: 로그인 URL과 base_url 자동 동기화
- **프로젝트 중단**: 안전한 프로젝트 중단 기능
- **API 통신**: FastAPI를 통한 프론트엔드-백엔드 통신
- **독립 실행**: 포트 8001에서 독립적으로 실행

## 📊 API 엔드포인트

### 서버 상태
- `GET /` - 메인 페이지
- `GET /api/health` - 서버 상태 확인

### 설정 관리
- `GET /api/config` - 설정 로드
- `POST /api/config` - 설정 저장

### 프로젝트 실행
- `POST /api/start` - 프로젝트 시작
- `POST /api/stop` - 프로젝트 중단
- `GET /api/status` - 실행 상태 확인
- `GET /api/history` - 실행 이력 조회

### 파일 관리
- `POST /api/upload-excel` - Excel 파일 업로드
- `GET /api/uploaded-files` - 업로드된 파일 정보 조회

### 공통 데이터
- `GET /api/channels` - 채널 목록
- `GET /api/order-statuses` - 주문 상태 목록
- `GET /api/change-statuses` - 변경 가능한 상태 목록
- `GET /api/search-statuses` - 검색용 상태 목록
- `GET /api/sale-types` - 판매 유형 목록
- `GET /api/date-types` - 날짜 유형 목록
- `GET /api/excel-data` - 모든 Excel 데이터

## 🐛 문제 해결

### ChromeDriver 오류
- Chrome 브라우저가 설치되어 있는지 확인
- 인터넷 연결 상태 확인 (자동 다운로드)
- `webdriver-manager`가 자동으로 적절한 버전을 다운로드합니다

### 포트 충돌
- 환경변수 `PORT`로 포트 변경 가능
- 기본값: 8001
- 예: `set PORT=8002 && python main.py`

### 설정 파일 오류
- `admin_confirm_config.json` 파일 형식 확인
- JSON 문법 오류 확인
- 설정 저장 시 자동으로 검증됩니다

### 프로젝트 중단이 안 될 때
- 상태 폴링이 정상 작동하는지 확인
- 브라우저 콘솔에서 오류 확인
- 필요시 페이지 새로고침

## 📝 로그 및 결과

- **로그 파일**: `logs/` 폴더에 저장 (예: `로그_v2.0_001_20251103.txt`)
  - 모든 로그 메시지에 주문번호가 포함되어 문제 추적이 용이합니다
  - 실행 시간, 검색 URL, 상태 변경 결과 등이 기록됩니다

- **결과 파일**: `results/` 폴더에 저장 (예: `전송여부결과_v2.0_001_20251103.txt`)
  - 주문번호, 확정번호, 상태 변경 결과, LMS 전송 결과가 기록됩니다
  - 탭 구분자로 구분된 형식 (TSV)

- **실행 이력**: 웹 인터페이스에서 확인
  - 시작 시간, 종료 시간, 상태, 실행 시간 등

## 🔒 보안

- Lock 파일을 통한 동시 실행 방지
- 임시 설정 파일 자동 정리
- 안전한 프로세스 종료
- 비밀번호는 localStorage에 저장되지 않음

## 📦 의존성

- `fastapi==0.104.1` - 웹 프레임워크
- `uvicorn==0.24.0` - ASGI 서버
- `selenium==4.15.2` - 웹 자동화
- `webdriver-manager==4.0.1` - ChromeDriver 자동 관리
- `pandas==2.1.3` - 데이터 처리
- `openpyxl==3.1.2` - Excel 파일 처리
- `python-multipart==0.0.6` - 파일 업로드 지원

## 🔄 버전 히스토리

### v2.0 (2025-11-03)
- URL 자동 동기화 기능 추가
- 프로젝트 중단 기능 개선
- localStorage 자동 저장 기능 추가
- 각 탭별 저장 기능 구현
- 상태 폴링 개선
- 프론트엔드 UX 개선

## 📞 지원

문제 발생 시 다음을 확인하세요:
1. 로그 파일 확인 (`logs/` 폴더)
2. 실행 이력 확인 (웹 인터페이스)
3. 설정 파일 형식 확인 (`admin_confirm_config.json`)
4. ChromeDriver 상태 확인
5. 브라우저 콘솔 확인 (F12)

## 📄 라이선스

이 프로젝트는 내부 사용을 위한 것입니다.
